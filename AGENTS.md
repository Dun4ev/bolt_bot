# Repository Guidelines

## Проектная структура и модули
`bolt_bot.py` содержит весь приложенийный код: Telegram-хендлеры, HTTP-клиента для LM Studio и настройки логирования. Конфигурация LM Studio/Telegram задаётся константами и переменными окружения; вынесите чувствительные значения из кода при подготовке к продакшену. Вспомогательные заметки храните в `docs/` (создайте при необходимости), тесты — в `tests/`, а дополнительные промпты и шаблоны — в `prompts/`.

## Сборка, запуск и тесты
Используйте Python 3.11+ и отдельный `venv`. Полезные команды:
```bash
python3 -m venv .venv && source .venv/bin/activate
pip install python-telegram-bot requests
python bolt_bot.py               # локальный поллинг-бот
pytest -q                        # минимальные регрессионные тесты
```
Для ручного прогона без Telegram CLI можно временно вызывать `ask_lmstudio()` из REPL, передавая промпты напрямую.

## Стиль и наименование
Следуем PEP 8, 4 пробела, именование функций/переменных в snake_case. Логи формируйте через `logging`, а сетевые вызовы инкапсулируйте в чистые функции (`ask_lmstudio`, `ask_llm`). Комментарии и докстринги — на русском языке; пользовательский вывод — адаптивный, но не смешивайте английский и кириллицу в одной фразе без необходимости.

## Тестирование
Рекомендуемый стек — `pytest` + `pytest-asyncio`. Для функций, обращающихся к LM Studio, внедряйте фикстуры с заглушками `requests.post`. Покрывайте сценарии ошибок (таймауты, неверный JSON) и happy-path; цель — ≥80 % критических веток. Именуйте тесты как `test_<feature>_<case>`.

## Коммиты и Pull Request
История репозитория показывает короткие императивные сообщения («Update file…»). Сохраняем стиль: одно изменение — один коммит, заголовок ≤72 символов. PR должен описывать цель, шаги проверки и влияние на LM Studio/Telegram конфигурацию; прикладывайте вывод тестов и скриншоты Telegram-бота при изменении UX.

## Безопасность и конфигурация
Токены Telegram задавайте через `TELEGRAM_TOKEN` в окружении или `.env` (не коммить). Хост LM Studio передавайте параметром или переменной `LM_STUDIO_ENDPOINT`, не хардкодьте пользовательские адреса. Валидируйте входящие тексты: ограничивайте длину, фильтруйте команды и логируйте подозрительный ввод.

### Переключение LLM backend
- В `.env` поддерживаются переменные: `LM_STUDIO_ENDPOINT`, `LM_STUDIO_MODEL`, `LM_STUDIO_CARD_MODEL`, `LLM_BACKEND`, `GEMINI_API_KEY`, `GEMINI_MODEL`.
- По умолчанию `LLM_BACKEND=lm_studio` и запросы идут в локальный OpenAI-совместимый сервер LM Studio, адрес настраивайте через `LM_STUDIO_ENDPOINT`.
- Чтобы использовать Google AI Studio (Gemini), пропишите в `.env` `LLM_BACKEND=gemini`, укажите `GEMINI_API_KEY` и нужную модель в `GEMINI_MODEL` (например, `gemini-1.5-flash`).
- При backend=gemini ключ обязателен: отсутствие `GEMINI_API_KEY` приводит к ошибке запуска. Остальные переменные (Telegram токен, LM Studio параметры) остаются для локального режима и резервного использования.
- В режиме работы бота доступны команды `/menu` и `/backend`: первая показывает клавиатуру с кнопками («Стихотворение», «Выбрать backend»), вторая открывает inline-меню для переключения источника ответов. Выбор действует до следующего переключения.

## Документация и версии — LITE
**Источник правды по агентам:** один файл `AGENTS.md`. Если в проекте встречается `GEMINI.md` — перенеси релевантное и удали файл-двойник (единый контекст снижает риски рассинхронизации).

**Когда менять документы и версию**

- Если меняется публичное поведение (API/CLI/конфиги/форматы/дефолты/коды ошибок):
  1) обнови `README.md` (примеры, параметры, конфиги),
  2) добавь запись в `CHANGELOG.md` по Keep a Changelog (категории: Added/Changed/Fixed/Deprecated/Removed; пометь BREAKING),
  3) бампни SemVer: MAJOR — несовместимое, MINOR — совместимая функциональность, PATCH — исправления.
- Если изменение **внутреннее** (рефактор/оптимизация) и не трогает публичный контракт — запись в `CHANGELOG.md` **не обязательна**.

**План работ**

- Долгосрочные задачи храним в `docs/ROADMAP.md` с метками: `todo` / `in-progress` / `blocked` / `done`.
